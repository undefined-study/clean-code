# [13장] 동시성

이 장에서는 여러 스레드를 동시에 돌리는 이유를 논한다.

## 동시성이 필요한 이유?

동시성은 무엇과 언제를 분리하는 전략이다.

### 미신과 오해

- 동시성은 항상 성능을 높여준다
  동시성은 때로 성능을 높여준다. 대기 시간이 아주 길어 여러 스레드가 프로세서를 공유 할 수 있거나, 여러 프로세서가 동시에 처리할 독립적인 계산이 충분히 많은 경우에만 성능이 높아진다.
- 동시성을 구현해도 설계는 변하지 않는다.
  단일 스레드 시스템과 다중 스레드 시스템은 설계가 판이하게 다르기 때문에 시스템 구조가 크게 달라진다.
- 웹 또는 EJB 컨테이너를 사용하면 동시성을 이해할 필요가 없다.
  컨테이너가 어떻게 동작하는지, 어떻게 동시 수정, 데드락 같은 문제를 피할 수 있는지 알아야만 한다.

동시성은 다소 부하를 유발한다.

동시성은 복잡하다.

일반적으로 동시성 버그는 재현하기 어렵다.

동시성을 구현하려면 흔히 근본적인 설계 전략을 재고해야 한다.

## 동시성 방어 원칙

동시성 코드가 일으키는 문제로부터 시스템을 방어하는 원칙과 기술을 소개한다.

## 프로세스와 스레드

window 운영체제 기준으로 exe파일들을 프로그램이라고 한다.

프로그램이 실행되지 않아서 정적 프로그램 줄여서 프로그램이라고 한다.

프로그램을 실행하려면 움직이는 작업 공간이 생겨야하는데 그것이 바로 프로세스이다.

## 프로세스

프로그램을 실행시켰을 때, 정적인 프로그램이 동적으로 변할 때, 프로그램이 실행되고 있는 상태를 프로세스라고 한다.

운영체제가 여러 프로세스를 동시에 실행하는 것을 멀티테스킹이라고 한다.

## 스레드

하나의 프로세스 안에서도 여러가지 작업들이 동시에 진행될 수 있다.

이렇게 하나의 프로세스 내에서 동시에 진행되는 작업들을 스레드라고 한다.

한 프로세스 내에서 Heap, Data, Code 영역을 공유 (멀티 스레드인 경우)

각 각의 스레드는 독립적인 작업을 수행해야 하기 때문에 고유한 스레드 ID, 프로그램 카운터, 레지스터 집합, 스택을 가지고 있다.

## 멀티 스레드

프로그램을 둘 이상 동시에 실행하는 기술이다.

이러한 작업은 컨텍스트 스위칭(Context switching)을 통해서 일어난다.

## 싱글 스레드

하나의 프로세스에서 하나의 스레드로만 실행한다.

컨텍스트 스위칭을 하지않는다.

단순 cpu만을 사용하는 계산작업은 멀티스레드보다 싱글스레드가 더 효율적이다.

Node는 싱글스레드가 아니지만 자바스크립트를 실행하는 스레드는 하나이므로 Node를 싱글스레드라고 한다.

그 싱글스레드가 이벤트 루프이다.

## 이벤트 루프

js는 싱글 스레드 기반 언어여서 한번에 하나씩 작업을 진행한다.

하지만 이벤트 루프를 이용해 동시성을 지원한다. (브라우저, node.js에서 지원)

이벤트 루프 → 태스크 큐로 콜백 함수 전달 → 콜스택 (콜스택에 함수가 없을 때만 전달해준다)

태스크 큐는 콜백함수들이 기다리는 공간, FIFO 방식을 따른다.
